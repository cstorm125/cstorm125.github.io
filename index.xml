<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>chariblog</title>
<link>https://cstorm125.github.io/</link>
<atom:link href="https://cstorm125.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description>A collection of technical writings on applied science</description>
<generator>quarto-1.5.57</generator>
<lastBuildDate>Mon, 25 Nov 2024 00:00:00 GMT</lastBuildDate>
<item>
  <title>Predict How Much A Customer Will Spend in Retail</title>
  <dc:creator>cstorm125 </dc:creator>
  <link>https://cstorm125.github.io/posts/sales_prediction/</link>
  <description><![CDATA[ 




<p>I have spent nearly a decade as a data scientist in the retail sector, but I did not realize I have been approaching customer sales predictions the wrong way until I attended <a href="https://scholar.google.com/citations?user=EZ9sTM4AAAAJ&amp;hl=en">Gregory M. Duncan</a>â€™s lecture.</p>
<div id="b2ec8770" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ucimlrepo <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fetch_ucirepo </span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> boto3</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm.auto <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split</span>
<span id="cb1-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> autogluon.tabular <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TabularDataset, TabularPredictor</span>
<span id="cb1-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> (</span>
<span id="cb1-12">    mean_squared_error, mean_absolute_error, r2_score, median_absolute_error,</span>
<span id="cb1-13">    accuracy_score, precision_score, recall_score, f1_score, confusion_matrix</span>
<span id="cb1-14">)</span>
<span id="cb1-15"></span>
<span id="cb1-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pearsonr, wasserstein_distance</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> calculate_regression_metrics(y_true, y_pred):</span>
<span id="cb1-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb1-20">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'root_mean_squared_error'</span>: np.sqrt(mean_squared_error(y_true, y_pred)),</span>
<span id="cb1-21">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mean_squared_error'</span>: mean_squared_error(y_true, y_pred),</span>
<span id="cb1-22">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mean_absolute_error'</span>: mean_absolute_error(y_true, y_pred),</span>
<span id="cb1-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r2'</span>: r2_score(y_true, y_pred),</span>
<span id="cb1-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pearsonr'</span>: pearsonr(y_true, y_pred)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb1-25">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'median_absolute_error'</span>: median_absolute_error(y_true, y_pred),</span>
<span id="cb1-26">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'earths_mover_distance'</span>: wasserstein_distance(y_true, y_pred)</span>
<span id="cb1-27">    }</span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> caluclate_classification_metrics(y_true, y_pred):</span>
<span id="cb1-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb1-31">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'accuracy'</span>: accuracy_score(y_true, y_pred),</span>
<span id="cb1-32">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'precision'</span>: precision_score(y_true, y_pred, average<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weighted'</span>),</span>
<span id="cb1-33">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'recall'</span>: recall_score(y_true, y_pred, average<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weighted'</span>),</span>
<span id="cb1-34">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'f1_score'</span>: f1_score(y_true, y_pred, average<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weighted'</span>),</span>
<span id="cb1-35">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confusion_matrix'</span>: confusion_matrix(y_true, y_pred)</span>
<span id="cb1-36">    }</span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> string_to_yearmon(date):</span>
<span id="cb1-39">    date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date.split()</span>
<span id="cb1-40">    date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/'</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> date[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">':'</span>)</span>
<span id="cb1-41">    date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> date[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].zfill(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#+ '-' + date[1].zfill(2) + ' ' + date[3].zfill(2) + ':' + date[4].zfill(2)</span></span>
<span id="cb1-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> date</span>
<span id="cb1-43"></span>
<span id="cb1-44"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> call_llama(system_prompt, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>):</span>
<span id="cb1-45">    template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""&lt;s&gt;[INST] &lt;&lt;SYS&gt;&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>system_prompt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&lt;&lt;/SYS&gt;&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[/INST]"""</span></span>
<span id="cb1-46">    client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> boto3.client(service_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bedrock-runtime'</span>,region_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'us-west-2'</span>)</span>
<span id="cb1-47">    body <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.dumps({</span>
<span id="cb1-48">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prompt"</span>: template,</span>
<span id="cb1-49">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temperature"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span>,</span>
<span id="cb1-50">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top_p"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,</span>
<span id="cb1-51">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_gen_len"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>,</span>
<span id="cb1-52">    })</span>
<span id="cb1-53">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.invoke_model(</span>
<span id="cb1-54">        body<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>body,</span>
<span id="cb1-55">        modelId<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'us.meta.llama3-2-90b-instruct-v1:0'</span>,</span>
<span id="cb1-56">        accept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'application/json'</span>,</span>
<span id="cb1-57">        contentType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'application/json'</span></span>
<span id="cb1-58">    )</span>
<span id="cb1-59">    response_body <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.loads(response[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'body'</span>].read())</span>
<span id="cb1-60">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response_body</span>
<span id="cb1-61"></span>
<span id="cb1-62"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> call_claude(system_prompt, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>):</span>
<span id="cb1-63">    client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> boto3.client(service_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bedrock-runtime'</span>,region_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'us-west-2'</span>)</span>
<span id="cb1-64">    body<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>json.dumps(</span>
<span id="cb1-65">        {</span>
<span id="cb1-66">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"anthropic_version"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bedrock-2023-05-31"</span>,</span>
<span id="cb1-67">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_tokens"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span>,</span>
<span id="cb1-68">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>: [</span>
<span id="cb1-69">                {</span>
<span id="cb1-70">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>,</span>
<span id="cb1-71">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: [</span>
<span id="cb1-72">                    {</span>
<span id="cb1-73">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>,</span>
<span id="cb1-74">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>: system_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>,</span>
<span id="cb1-75">                    }</span>
<span id="cb1-76">                    ]</span>
<span id="cb1-77">                }</span>
<span id="cb1-78">                ]</span>
<span id="cb1-79">        }  </span>
<span id="cb1-80">    )  </span>
<span id="cb1-81"></span>
<span id="cb1-82">    </span>
<span id="cb1-83">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.invoke_model(body<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>body, </span>
<span id="cb1-84">                                   modelId<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'anthropic.claude-3-5-sonnet-20241022-v2:0'</span>,</span>
<span id="cb1-85">                                   contentType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'application/json'</span>,</span>
<span id="cb1-86">                                   accept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'application/json'</span>)</span>
<span id="cb1-87">    response_body <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.loads(response.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'body'</span>).read())</span>
<span id="cb1-88">   </span>
<span id="cb1-89">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response_body</span></code></pre></div>
</details>
</div>
<div id="678d3a8a" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">online_retail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fetch_ucirepo(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">352</span>) </span>
<span id="cb2-2">transaction_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> online_retail[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original'</span>]</span>
<span id="cb2-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(transaction_df.shape)</span>
<span id="cb2-4">transaction_df.head(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(541909, 8)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">InvoiceNo</th>
<th data-quarto-table-cell-role="th">StockCode</th>
<th data-quarto-table-cell-role="th">Description</th>
<th data-quarto-table-cell-role="th">Quantity</th>
<th data-quarto-table-cell-role="th">InvoiceDate</th>
<th data-quarto-table-cell-role="th">UnitPrice</th>
<th data-quarto-table-cell-role="th">CustomerID</th>
<th data-quarto-table-cell-role="th">Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>536365</td>
<td>85123A</td>
<td>WHITE HANGING HEART T-LIGHT HOLDER</td>
<td>6</td>
<td>12/1/2010 8:26</td>
<td>2.55</td>
<td>17850.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>536365</td>
<td>71053</td>
<td>WHITE METAL LANTERN</td>
<td>6</td>
<td>12/1/2010 8:26</td>
<td>3.39</td>
<td>17850.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>536365</td>
<td>84406B</td>
<td>CREAM CUPID HEARTS COAT HANGER</td>
<td>8</td>
<td>12/1/2010 8:26</td>
<td>2.75</td>
<td>17850.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>536365</td>
<td>84029G</td>
<td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
<td>6</td>
<td>12/1/2010 8:26</td>
<td>3.39</td>
<td>17850.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>536365</td>
<td>84029E</td>
<td>RED WOOLLY HOTTIE WHITE HEART.</td>
<td>6</td>
<td>12/1/2010 8:26</td>
<td>3.39</td>
<td>17850.0</td>
<td>United Kingdom</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>



 ]]></description>
  <category>news</category>
  <category>code</category>
  <category>analysis</category>
  <guid>https://cstorm125.github.io/posts/sales_prediction/</guid>
  <pubDate>Mon, 25 Nov 2024 00:00:00 GMT</pubDate>
  <media:content url="https://cstorm125.github.io/posts/sales_prediction/featured_image.jpg" medium="image" type="image/jpeg"/>
</item>
</channel>
</rss>
