<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="cstorm125">
<meta name="dcterms.date" content="2025-06-29">

<title>(Almost) All SQL You Need – chariblog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-fa6ebe1abc24c69c1ddb9a141d0fa116.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">chariblog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cstorm125"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/cstorm125/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://scholar.google.com/citations?user=UX36NGkAAAAJ"> <i class="bi bi-google" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#intuition" id="toc-intuition" class="nav-link active" data-scroll-target="#intuition">0. Intuition</a></li>
  <li><a href="#sanity-checks-keep-you-sane" id="toc-sanity-checks-keep-you-sane" class="nav-link" data-scroll-target="#sanity-checks-keep-you-sane">1. Sanity Checks Keep You Sane</a>
  <ul class="collapse">
  <li><a href="#example-select" id="toc-example-select" class="nav-link" data-scroll-target="#example-select">Example: <code>select *</code></a></li>
  <li><a href="#example-describe" id="toc-example-describe" class="nav-link" data-scroll-target="#example-describe">Example: <code>describe</code></a></li>
  <li><a href="#example-count-and-countdistinct-column" id="toc-example-count-and-countdistinct-column" class="nav-link" data-scroll-target="#example-count-and-countdistinct-column">Example: <code>count</code> and <code>count(distinct [COLUMN])</code></a></li>
  </ul></li>
  <li><a href="#assorted-platter-of-selects" id="toc-assorted-platter-of-selects" class="nav-link" data-scroll-target="#assorted-platter-of-selects">2. Assorted Platter of Selects</a>
  <ul class="collapse">
  <li><a href="#example-who-are-the-users-that-viewed-item-2067266" id="toc-example-who-are-the-users-that-viewed-item-2067266" class="nav-link" data-scroll-target="#example-who-are-the-users-that-viewed-item-2067266">Example: Who are the users that viewed item 2067266?</a></li>
  <li><a href="#example-who-are-the-users-that-viewed-item-2067266-ranked-by-who-viewed-last-to-who-viewed-first" id="toc-example-who-are-the-users-that-viewed-item-2067266-ranked-by-who-viewed-last-to-who-viewed-first" class="nav-link" data-scroll-target="#example-who-are-the-users-that-viewed-item-2067266-ranked-by-who-viewed-last-to-who-viewed-first">Example: Who are the users that viewed item 2067266, ranked by who viewed last to who viewed first?</a></li>
  <li><a href="#example-how-many-users-did-not-buy" id="toc-example-how-many-users-did-not-buy" class="nav-link" data-scroll-target="#example-how-many-users-did-not-buy">Example: How many users did not buy?</a></li>
  <li><a href="#example-how-many-events-happened-before-november-26-2017-timestamp-1511622000" id="toc-example-how-many-events-happened-before-november-26-2017-timestamp-1511622000" class="nav-link" data-scroll-target="#example-how-many-events-happened-before-november-26-2017-timestamp-1511622000">Example: How many events happened before November 26, 2017 (timestamp 1511622000)?</a></li>
  <li><a href="#example-how-many-events-happened-between-november-25-2017-timestamp-1511535600-and-november-26-2017-timestamp-1511622000" id="toc-example-how-many-events-happened-between-november-25-2017-timestamp-1511535600-and-november-26-2017-timestamp-1511622000" class="nav-link" data-scroll-target="#example-how-many-events-happened-between-november-25-2017-timestamp-1511535600-and-november-26-2017-timestamp-1511622000">Example: How many events happened between November 25, 2017 (timestamp 1511535600) and November 26, 2017 (timestamp 1511622000)?</a></li>
  <li><a href="#example-how-many-events-are-either-purchase-buy-or-add-to-cart-cart" id="toc-example-how-many-events-are-either-purchase-buy-or-add-to-cart-cart" class="nav-link" data-scroll-target="#example-how-many-events-are-either-purchase-buy-or-add-to-cart-cart">Example: How many events are either purchase (<code>buy</code>) or add-to-cart (<code>cart</code>)?</a></li>
  <li><a href="#example-how-many-users-interact-pv-cart-fav-with-taobao-but-never-buy" id="toc-example-how-many-users-interact-pv-cart-fav-with-taobao-but-never-buy" class="nav-link" data-scroll-target="#example-how-many-users-interact-pv-cart-fav-with-taobao-but-never-buy">Example: How many users interact (<code>pv</code>, <code>cart</code>, <code>fav</code>) with Taobao but never <code>buy</code>?</a></li>
  <li><a href="#example-how-many-behavior_type-ends-with-a-v" id="toc-example-how-many-behavior_type-ends-with-a-v" class="nav-link" data-scroll-target="#example-how-many-behavior_type-ends-with-a-v">Example: How many <code>behavior_type</code> ends with a <code>v</code>?</a></li>
  </ul></li>
  <li><a href="#partitions-partitions-partitions" id="toc-partitions-partitions-partitions" class="nav-link" data-scroll-target="#partitions-partitions-partitions">3. Partitions, Partitions, Partitions</a>
  <ul class="collapse">
  <li><a href="#example-who-are-the-users-that-viewed-item-2067266-run-without-partition-in-where-clause." id="toc-example-who-are-the-users-that-viewed-item-2067266-run-without-partition-in-where-clause." class="nav-link" data-scroll-target="#example-who-are-the-users-that-viewed-item-2067266-run-without-partition-in-where-clause.">Example: Who are the users that viewed item 2067266? Run WITHOUT partition in <code>where</code> clause.</a></li>
  <li><a href="#example-who-are-the-users-that-viewed-item-2067266-run-with-category_id-partition-in-where-clause." id="toc-example-who-are-the-users-that-viewed-item-2067266-run-with-category_id-partition-in-where-clause." class="nav-link" data-scroll-target="#example-who-are-the-users-that-viewed-item-2067266-run-with-category_id-partition-in-where-clause.">Example: Who are the users that viewed item 2067266? Run WITH <code>category_id</code> partition in <code>where</code> clause.</a></li>
  </ul></li>
  <li><a href="#column-wise-manipulation" id="toc-column-wise-manipulation" class="nav-link" data-scroll-target="#column-wise-manipulation">4. Column-wise Manipulation</a>
  <ul class="collapse">
  <li><a href="#example-add-price-column-where-price-is-item_id-modulus-1000-50" id="toc-example-add-price-column-where-price-is-item_id-modulus-1000-50" class="nav-link" data-scroll-target="#example-add-price-column-where-price-is-item_id-modulus-1000-50">Example: Add <code>price</code> column where price is <code>item_id</code> modulus 1000 + 50</a></li>
  <li><a href="#example-add-quantity-column-that-is-a-random-number-between-1-and-10-only-for-buy-events.-for-all-other-events-leave-it-as-missing-values-null." id="toc-example-add-quantity-column-that-is-a-random-number-between-1-and-10-only-for-buy-events.-for-all-other-events-leave-it-as-missing-values-null." class="nav-link" data-scroll-target="#example-add-quantity-column-that-is-a-random-number-between-1-and-10-only-for-buy-events.-for-all-other-events-leave-it-as-missing-values-null.">Example: Add <code>quantity</code> column that is a random number between 1 and 10, only for <code>buy</code> events. For all other events, leave it as missing values (<code>null</code>).</a></li>
  <li><a href="#example-calculate-sales-by-multiplying-price-and-quantity" id="toc-example-calculate-sales-by-multiplying-price-and-quantity" class="nav-link" data-scroll-target="#example-calculate-sales-by-multiplying-price-and-quantity">Example: Calculate <code>sales</code> by multiplying <code>price</code> and <code>quantity</code></a></li>
  <li><a href="#example-fill-in-missing-values-in-sales-with-zero." id="toc-example-fill-in-missing-values-in-sales-with-zero." class="nav-link" data-scroll-target="#example-fill-in-missing-values-in-sales-with-zero.">Example: Fill in missing values in <code>sales</code> with zero.</a></li>
  <li><a href="#example-convert-timestamp-from-unix-timestamp-to-yyyy-mm-dd-format." id="toc-example-convert-timestamp-from-unix-timestamp-to-yyyy-mm-dd-format." class="nav-link" data-scroll-target="#example-convert-timestamp-from-unix-timestamp-to-yyyy-mm-dd-format.">Example: Convert timestamp from unix timestamp to <code>yyyy-mm-dd</code> format.</a></li>
  <li><a href="#example-make-a-string-column-year_month-that-takes-only-the-yyyy-mm-part-from-event_timestamp." id="toc-example-make-a-string-column-year_month-that-takes-only-the-yyyy-mm-part-from-event_timestamp." class="nav-link" data-scroll-target="#example-make-a-string-column-year_month-that-takes-only-the-yyyy-mm-part-from-event_timestamp.">Example: Make a string column <code>year_month</code> that takes only the <code>yyyy-mm</code> part from <code>event_timestamp</code>.</a></li>
  <li><a href="#example-save-the-manipulations-done-so-far-as-a-view-to-be-used-later." id="toc-example-save-the-manipulations-done-so-far-as-a-view-to-be-used-later." class="nav-link" data-scroll-target="#example-save-the-manipulations-done-so-far-as-a-view-to-be-used-later.">Example: Save the manipulations done so far as a <code>view</code> to be used later.</a></li>
  </ul></li>
  <li><a href="#aggregation-aka-group-by" id="toc-aggregation-aka-group-by" class="nav-link" data-scroll-target="#aggregation-aka-group-by">5. Aggregation aka Group By</a>
  <ul class="collapse">
  <li><a href="#example-how-many-events-are-there-for-each-event-type-behavior_type" id="toc-example-how-many-events-are-there-for-each-event-type-behavior_type" class="nav-link" data-scroll-target="#example-how-many-events-are-there-for-each-event-type-behavior_type">Example: How many events are there for each event type (<code>behavior_type</code>)?</a></li>
  <li><a href="#example-what-are-the-top-10-items-that-got-favorited-by-most-number-of-unique-customers" id="toc-example-what-are-the-top-10-items-that-got-favorited-by-most-number-of-unique-customers" class="nav-link" data-scroll-target="#example-what-are-the-top-10-items-that-got-favorited-by-most-number-of-unique-customers">Example: What are the top 10 items that got favorited by most number of unique customers?</a></li>
  <li><a href="#example-what-is-the-average-standard-deviation-min-and-max-spend-per-user" id="toc-example-what-is-the-average-standard-deviation-min-and-max-spend-per-user" class="nav-link" data-scroll-target="#example-what-is-the-average-standard-deviation-min-and-max-spend-per-user">Example: What is the average, standard deviation, min, and max spend per user?</a></li>
  <li><a href="#example-how-many-percentage-of-customer-purchased-at-least-once" id="toc-example-how-many-percentage-of-customer-purchased-at-least-once" class="nav-link" data-scroll-target="#example-how-many-percentage-of-customer-purchased-at-least-once">Example: How many percentage of customer purchased at least once?</a></li>
  <li><a href="#example-give-me-only-customers-who-have-bought-at-least-one-item-more-expensive-than-100." id="toc-example-give-me-only-customers-who-have-bought-at-least-one-item-more-expensive-than-100." class="nav-link" data-scroll-target="#example-give-me-only-customers-who-have-bought-at-least-one-item-more-expensive-than-100.">Example: Give me only customers who have bought at least one item more expensive than $100.</a></li>
  <li><a href="#example-for-each-user-who-have-favorited-anything-give-me-a-list-of-items-they-have-favorited-ordered-by-timestamp-in-ascending-order." id="toc-example-for-each-user-who-have-favorited-anything-give-me-a-list-of-items-they-have-favorited-ordered-by-timestamp-in-ascending-order." class="nav-link" data-scroll-target="#example-for-each-user-who-have-favorited-anything-give-me-a-list-of-items-they-have-favorited-ordered-by-timestamp-in-ascending-order.">Example: For each user who have favorited anything, give me a list of items they have favorited ordered by timestamp in ascending order.</a></li>
  </ul></li>
  <li><a href="#window-function" id="toc-window-function" class="nav-link" data-scroll-target="#window-function">6. Window Function</a>
  <ul class="collapse">
  <li><a href="#example-for-each-user-find-their-second-to-last-event." id="toc-example-for-each-user-find-their-second-to-last-event." class="nav-link" data-scroll-target="#example-for-each-user-find-their-second-to-last-event.">Example: For each user, find their second-to-last event.</a></li>
  <li><a href="#example-what-is-the-first-item-in-each-category-that-each-user-view" id="toc-example-what-is-the-first-item-in-each-category-that-each-user-view" class="nav-link" data-scroll-target="#example-what-is-the-first-item-in-each-category-that-each-user-view">Example: What is the first item in each category that each user view?</a></li>
  <li><a href="#example-for-each-user-what-was-their-previous-action-before-a-buy-action" id="toc-example-for-each-user-what-was-their-previous-action-before-a-buy-action" class="nav-link" data-scroll-target="#example-for-each-user-what-was-their-previous-action-before-a-buy-action">Example: For each user, what was their previous action before a <code>buy</code> action?</a></li>
  <li><a href="#example-what-is-the-contribution-of-each-item-to-their-overall-category-sales" id="toc-example-what-is-the-contribution-of-each-item-to-their-overall-category-sales" class="nav-link" data-scroll-target="#example-what-is-the-contribution-of-each-item-to-their-overall-category-sales">Example: What is the contribution of each item to their overall category sales?</a></li>
  </ul></li>
  <li><a href="#concatenation-aka-union" id="toc-concatenation-aka-union" class="nav-link" data-scroll-target="#concatenation-aka-union">7. Concatenation aka Union</a>
  <ul class="collapse">
  <li><a href="#example-concatenate-monthly-summary-of-2017-11-and-2017-12-together." id="toc-example-concatenate-monthly-summary-of-2017-11-and-2017-12-together." class="nav-link" data-scroll-target="#example-concatenate-monthly-summary-of-2017-11-and-2017-12-together.">Example: Concatenate monthly summary of <code>2017-11</code> and <code>2017-12</code> together.</a></li>
  <li><a href="#example-give-me-a-list-of-unique-users-who-made-at-least-one-purchase-or-viewed-at-least-5-unique-items." id="toc-example-give-me-a-list-of-unique-users-who-made-at-least-one-purchase-or-viewed-at-least-5-unique-items." class="nav-link" data-scroll-target="#example-give-me-a-list-of-unique-users-who-made-at-least-one-purchase-or-viewed-at-least-5-unique-items.">Example: Give me a list of unique users who made at least one purchase or viewed at least 5 unique items.</a></li>
  </ul></li>
  <li><a href="#joins" id="toc-joins" class="nav-link" data-scroll-target="#joins">8. Joins</a>
  <ul class="collapse">
  <li><a href="#example-among-users-who-are-active-have-at-least-one-event-on-2017-12-03-how-many-percent-were-active-in-2017-11" id="toc-example-among-users-who-are-active-have-at-least-one-event-on-2017-12-03-how-many-percent-were-active-in-2017-11" class="nav-link" data-scroll-target="#example-among-users-who-are-active-have-at-least-one-event-on-2017-12-03-how-many-percent-were-active-in-2017-11">Example: Among users who are active (have at least one event) on 2017-12-03, how many percent were active in 2017-11</a></li>
  <li><a href="#example-what-is-the-daily-contribution-to-its-total-monthly-sales-expressed-as-percentage" id="toc-example-what-is-the-daily-contribution-to-its-total-monthly-sales-expressed-as-percentage" class="nav-link" data-scroll-target="#example-what-is-the-daily-contribution-to-its-total-monthly-sales-expressed-as-percentage">Example: What is the daily contribution to its total monthly sales, expressed as percentage?</a></li>
  </ul></li>
  <li><a href="#tribal-knowledge" id="toc-tribal-knowledge" class="nav-link" data-scroll-target="#tribal-knowledge">9. Tribal Knowledge</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">(Almost) All SQL You Need</h1>
  <div class="quarto-categories">
    <div class="quarto-category">sql</div>
    <div class="quarto-category">tutorial</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>cstorm125 </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 29, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Skill mastery is an endeavor of diminishing returns. You can get from zero to <a href="http://act-r.psy.cmu.edu/wordpress/wp-content/uploads/2012/12/63ACS_JRA_PR.1982.pdf">good enough</a> (think first-time chess player to 500 online rating) within 100 hours of deliberate practice; however, it is exponentially more difficult to get from good enough to <a href="https://www.researchgate.net/publication/224827585_The_Role_of_Deliberate_Practice_in_the_Acquisition_of_Expert_Performance">mastered</a> (think a 500-rated chess player trying to become a 2200-FIDE-rated Candidate Master), requiring over 100x more delibrate practice. SQL is the basic building blocks of data analysis and I posit that most peopleーproduct managers, marketers, salespeople, and other makeshift data analystsーsimply need to be good enough.</p>
<p>This tutorial aims to encapsulate almost all SQL techniques you need to glean actionable insights from your (<a href="https://stackoverflow.com/questions/18884728/difference-between-transactional-and-non-transactional">non-transactional</a>) datasets. We will use the <a href="https://www.kaggle.com/datasets/marwa80/userbehavior">Taobao User Behavior</a> dataset and <a href="https://duckdb.org/">duckdb</a> to simulate a SQL interface. There will be idiosyncracies according to which flavors of SQL you are usingーPostgres, Presto, Redshift, BigQuery, and so onーbut you should be able to adapt the principles outlined here with a little help of modern coding assistants.</p>
<p>I recommend that you first quickly skim through this post to have a rough idea of what SQL is all about, then move on to complete the <a href="https://colab.research.google.com/github/cstorm125/cstorm125.github.io/blob/main/notebook/sql_almost_exercise.ipynb">exercise</a> for some hands-on shenanigans. While completing it, feel free to refer back to this post and read some sections more in details. The road to becoming a true SQL monkey starts with writing queries.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="featured_image.jpg" class="img-fluid figure-img"></p>
<figcaption>featured_image</figcaption>
</figure>
</div>
<div id="822dfe17" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">6</span>) </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timeit</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'../../data/sql_almost/UserBehavior.csv'</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>      header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>df.columns <span class="op">=</span> [</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">'user_id'</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">'item_id'</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">'category_id'</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">'behavior_type'</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">'timestamp'</span>]</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">#sample 5M rows out of 100M to run in reasonable time</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sample(n<span class="op">=</span><span class="dv">5_000_000</span>, random_state<span class="op">=</span><span class="dv">112</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># # save to parquet</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># con = duckdb.connect()</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># con.register('transaction_tbl', df)</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># output_dir = '../../data/sql_almost/transaction_tbl'</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># os.makedirs(output_dir, exist_ok=True)</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># con.execute(f"""</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># COPY transaction_tbl</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># TO '{output_dir}'</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co"># (FORMAT PARQUET, PARTITION_BY (category_id, behavior_type), OVERWRITE_OR_IGNORE);</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># """)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="intuition" class="level2">
<h2 class="anchored" data-anchor-id="intuition">0. Intuition</h2>
<p>Imagine you are at a library to look for a certain piece of information. The entire library is off limits to the general public. The only way you can access any information is by telling the librarian exactly what you want and let them fetch it for you. The entire library is your <strong>database</strong>. The librarian is your <strong>query engine</strong> and what you tell them is your <strong>query</strong>. In the library, there are a number of shelves (representing <strong>tables</strong>) that contain any number of books (representing <strong>rows</strong> in a table) to answer your query. Each book from the same shelf contains the same number of pages (representing <strong>columns</strong> or <strong>fields</strong> in a row), each page having a distinct piece of information. Following your instruction, the librarian may walk to different shelves, scour some books and pages, mix-and-match the information, then present the answer to you. Therefore, our task is to give an instruction such that the librarian can give us the most accurate answer using the shortest time and energy possible.</p>
</section>
<section id="sanity-checks-keep-you-sane" class="level2">
<h2 class="anchored" data-anchor-id="sanity-checks-keep-you-sane">1. Sanity Checks Keep You Sane</h2>
<p>We are treating the <a href="https://www.kaggle.com/datasets/marwa80/userbehavior">Taobao User Behavior</a> dataset as our table called <code>transaction_tbl</code>. It is a 5M-row subset based on parquet files partitioned by <code>category_id</code> and <code>behavior_type</code>.</p>
<div id="d3af1054" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>con <span class="op">=</span> duckdb.<span class="ex">connect</span>()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#short-hand function to execute query with duckdb easily</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> execute_query(query): <span class="cf">return</span> con.execute(query).fetchdf()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="ss">CREATE OR REPLACE TABLE transaction_tbl AS</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="ss">SELECT *</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="ss">FROM read_parquet('../../data/sql_almost/transaction_tbl/*/*/*.parquet', hive_partitioning=true);</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#load saved, partitioned table as transaction_tbl</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The table is a run-of-the-mill user behavior log consisting of</p>
<ul>
<li><code>user_id</code>: identifier of user</li>
<li><code>item_id</code>: identifier of item</li>
<li><code>timestamp</code>: unix timestamp of when action happened</li>
<li><code>behavior_type</code>: what type of action it was</li>
<li><code>category_id</code>: identifier of category the item belongs to</li>
</ul>
<section id="example-select" class="level3">
<h3 class="anchored" data-anchor-id="example-select">Example: <code>select *</code></h3>
<p>The first thing you do with a table you have not seen before is to select a few rows to look at. The texts in variable <code>query</code> is what you would type in your SQL interface.</p>
<div id="f682b6a3" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select * from transaction_tbl limit 100;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>184439</td>
<td>688483</td>
<td>1512105722</td>
<td>buy</td>
<td>1000858</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>860167</td>
<td>3032030</td>
<td>1511876592</td>
<td>pv</td>
<td>1000858</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>29019</td>
<td>1174848</td>
<td>1511952716</td>
<td>pv</td>
<td>1000858</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">97</th>
<td>109393</td>
<td>336502</td>
<td>1512302682</td>
<td>pv</td>
<td>1003726</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">98</th>
<td>928768</td>
<td>2826670</td>
<td>1511780591</td>
<td>pv</td>
<td>1003726</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">99</th>
<td>719622</td>
<td>2297792</td>
<td>1511703912</td>
<td>pv</td>
<td>1003726</td>
</tr>
</tbody>
</table>

<p>100 rows × 5 columns</p>
</div>
</div>
</div>
<p><code>select *</code> returns all columns from a table, and is almost always followed by <code>limit [NUMBER OF ROWS YOU WANT]</code> in order to not return the entire table but a random subset of it. This is less of a problem in the day and age where most query engines have a built-in safeguard to not display the entire table as a result, otherwise you can crash your system by asking for a terabyte-level output.</p>
</section>
<section id="example-describe" class="level3">
<h3 class="anchored" data-anchor-id="example-describe">Example: <code>describe</code></h3>
<p>Another useful command is <code>describe</code>. It will tell you what the columns are, their data types, do they have null (missing) values and so on. Common data types are <code>int/bigint</code> for integers, <code>float</code> for approximate decimals, <code>varchar/string</code> for texts, <code>boolean</code> for true/false and <code>timestamp/date</code> for, well, timestamps and dates. However, they are always ever so slightly different depending on which SQL you are using so better confirm with the documentation such as <a href="https://prestodb.io/docs/current/language/types.html">this one for Presto</a>.</p>
<div id="80727b49" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ss">describe transaction_tbl;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column_name</th>
<th data-quarto-table-cell-role="th">column_type</th>
<th data-quarto-table-cell-role="th">null</th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">default</th>
<th data-quarto-table-cell-role="th">extra</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>user_id</td>
<td>BIGINT</td>
<td>YES</td>
<td>None</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>item_id</td>
<td>BIGINT</td>
<td>YES</td>
<td>None</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>timestamp</td>
<td>BIGINT</td>
<td>YES</td>
<td>None</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>behavior_type</td>
<td>VARCHAR</td>
<td>YES</td>
<td>None</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>category_id</td>
<td>BIGINT</td>
<td>YES</td>
<td>None</td>
<td>None</td>
<td>None</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-count-and-countdistinct-column" class="level3">
<h3 class="anchored" data-anchor-id="example-count-and-countdistinct-column">Example: <code>count</code> and <code>count(distinct [COLUMN])</code></h3>
<p>The last check you always want to do is to <code>count</code> how many rows exist in the table:</p>
<div id="a5fee1b0" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select count(*) from transaction_tbl;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count_star()</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>5000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can also count how many unique values are in any column by adding <code>distinct</code> in front of the column name in <code>count</code>. You can also name your derived columns to know which ones mean what using <code>as</code>.</p>
<div id="ec32bc92" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># count how many unique users</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ss"> count(*) as nb_event</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,count(distinct user_id) as nb_user</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">nb_event</th>
<th data-quarto-table-cell-role="th">nb_user</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>5000000</td>
<td>888335</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="assorted-platter-of-selects" class="level2">
<h2 class="anchored" data-anchor-id="assorted-platter-of-selects">2. Assorted Platter of Selects</h2>
<p>Now that you know how to sanity-check a table, let us move on to selecting what you want. This is often done by filtering the result with conditions using the <code>where</code> clause. Here are some examples you want to familiarize yourself with.</p>
<section id="example-who-are-the-users-that-viewed-item-2067266" class="level3">
<h3 class="anchored" data-anchor-id="example-who-are-the-users-that-viewed-item-2067266">Example: Who are the users that viewed item 2067266?</h3>
<p>Link multiple conditions with logical operators <code>and</code> / <code>or</code>.</p>
<div id="74187b93" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ss"> distinct user_id</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'pv'</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> and item_id = 2067266;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>377356</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>690994</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>485340</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>469061</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>457064</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>329947</td>
</tr>
</tbody>
</table>

<p>7 rows × 1 columns</p>
</div>
</div>
</div>
</section>
<section id="example-who-are-the-users-that-viewed-item-2067266-ranked-by-who-viewed-last-to-who-viewed-first" class="level3">
<h3 class="anchored" data-anchor-id="example-who-are-the-users-that-viewed-item-2067266-ranked-by-who-viewed-last-to-who-viewed-first">Example: Who are the users that viewed item 2067266, ranked by who viewed last to who viewed first?</h3>
<p>We use <code>order by [COLUMN]</code> followed by <code>asc</code> for ascending order (default) and <code>desc</code> for descending order.</p>
<div id="44788f76" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,timestamp</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'pv'</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> and item_id = 2067266</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="ss">order by timestamp desc;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>241453</td>
<td>1512288234</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>485340</td>
<td>1512160311</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>690994</td>
<td>1512127740</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>469061</td>
<td>1511865189</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>329947</td>
<td>1511850299</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>457064</td>
<td>1511601891</td>
</tr>
</tbody>
</table>

<p>7 rows × 2 columns</p>
</div>
</div>
</div>
</section>
<section id="example-how-many-users-did-not-buy" class="level3">
<h3 class="anchored" data-anchor-id="example-how-many-users-did-not-buy">Example: How many users did not buy?</h3>
<p><code>&lt;&gt;</code> means not equal.</p>
<div id="0b9c9ae7" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ss"> count(distinct user_id) </span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type &lt;&gt; 'buy';</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count(DISTINCT user_id)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>882077</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-how-many-events-happened-before-november-26-2017-timestamp-1511622000" class="level3">
<h3 class="anchored" data-anchor-id="example-how-many-events-happened-before-november-26-2017-timestamp-1511622000">Example: How many events happened before November 26, 2017 (timestamp 1511622000)?</h3>
<p><code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code> also works with numeric columns.</p>
<div id="4dc7bf7d" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ss"> count(*)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ss">where timestamp &lt; 1511622000;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count_star()</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>489758</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-how-many-events-happened-between-november-25-2017-timestamp-1511535600-and-november-26-2017-timestamp-1511622000" class="level3">
<h3 class="anchored" data-anchor-id="example-how-many-events-happened-between-november-25-2017-timestamp-1511535600-and-november-26-2017-timestamp-1511622000">Example: How many events happened between November 25, 2017 (timestamp 1511535600) and November 26, 2017 (timestamp 1511622000)?</h3>
<p>You can use <code>between</code> to replace <code>&gt;=</code> and <code>&lt;=</code>.</p>
<div id="476bd504" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ss"> count(*)</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ss">where timestamp between 1511535600 and 1511622000;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count_star()</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>487676</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-how-many-events-are-either-purchase-buy-or-add-to-cart-cart" class="level3">
<h3 class="anchored" data-anchor-id="example-how-many-events-are-either-purchase-buy-or-add-to-cart-cart">Example: How many events are either purchase (<code>buy</code>) or add-to-cart (<code>cart</code>)?</h3>
<p>We can use <code>in</code> in place of multiple <code>or</code></p>
<div id="8aa3bbb4" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ss"> count(*)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type in ('buy', 'cart');</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count_star()</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>376999</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Check to see if multiple <code>or</code> really gives the same result.</p>
<div id="f97c8b57" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ss"> count(*)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'buy' or behavior_type = 'cart';</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count_star()</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>376999</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-how-many-users-interact-pv-cart-fav-with-taobao-but-never-buy" class="level3">
<h3 class="anchored" data-anchor-id="example-how-many-users-interact-pv-cart-fav-with-taobao-but-never-buy">Example: How many users interact (<code>pv</code>, <code>cart</code>, <code>fav</code>) with Taobao but never <code>buy</code>?</h3>
<p>We can use <code>not</code> as a negation for <code>in</code>.</p>
<div id="c3bd2a06" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ss"> count(distinct user_id)</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type not in ('buy');</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count(DISTINCT user_id)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>882077</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-how-many-behavior_type-ends-with-a-v" class="level3">
<h3 class="anchored" data-anchor-id="example-how-many-behavior_type-ends-with-a-v">Example: How many <code>behavior_type</code> ends with a <code>v</code>?</h3>
<p>We use <code>like</code> to match texts that are similar what we want. <code>%</code> is the wild card to say anything can come before/after it. In this simple example, we already know the answer is 2: <code>pv</code> and <code>fav</code>.</p>
<div id="e3240c52" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ss"> count(distinct behavior_type)</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type like '%v';</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count(DISTINCT behavior_type)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="partitions-partitions-partitions" class="level2">
<h2 class="anchored" data-anchor-id="partitions-partitions-partitions">3. Partitions, Partitions, Partitions</h2>
<p>Once you have mastered the basic select patterns, the next thing you must never forget when selecting from a table is to <strong>ALWAYS SPECIFY THE PARTITIONS YOU NEED IN THE <code>WHERE</code> CLAUSE</strong>. A modern SQL table is stored as multiple compressed files (most commonly <code>parquet</code>) in a nested subfolder structure as seen below. In this case, the partitions (subfolders) are columns <code>category_id</code> and <code>behavior_type</code>.</p>
<blockquote class="blockquote">
<p>Fun Fact: Not only do you need to specify the partitions, you need to specify them with the <strong>correct data types</strong>. I once had a query than ran for 12 hours instead of 5 minutes, simply because I did not check if the partition was in datetime not string. Do not be me.</p>
</blockquote>
<div id="26f986d2" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_table_structure(table_path, first_category_id_dir):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print root folder</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(table_path.split(os.sep)[<span class="op">-</span><span class="dv">1</span>])  </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#get category_id partitions</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    category_ids <span class="op">=</span> <span class="bu">sorted</span>([d <span class="cf">for</span> d <span class="kw">in</span> os.listdir(table_path) <span class="cf">if</span> os.path.isdir(os.path.join(table_path, d)) <span class="kw">and</span> d.startswith(<span class="st">'category_id='</span>)])</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print only the first category_id partition</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    category_id_path <span class="op">=</span> os.path.join(table_path, first_category_id_dir)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  └── </span><span class="sc">{</span>first_category_id_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#get behavior_type partitions</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    behavior_types <span class="op">=</span> <span class="bu">sorted</span>([d <span class="cf">for</span> d <span class="kw">in</span> os.listdir(category_id_path) <span class="cf">if</span> os.path.isdir(os.path.join(category_id_path, d)) <span class="kw">and</span> d.startswith(<span class="st">'behavior_type='</span>)])</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print all behavior_type partitions</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> behavior_type_dir <span class="kw">in</span> behavior_types:</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>      behavior_type_path <span class="op">=</span> os.path.join(category_id_path, behavior_type_dir)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="ss">f"    └── </span><span class="sc">{</span>behavior_type_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">#get all parquet files</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>      files <span class="op">=</span> <span class="bu">sorted</span>([f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(behavior_type_path) <span class="cf">if</span> f.endswith(<span class="st">'.parquet'</span>)])</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">#print all files under category_id, behavior_type partitions</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> i, <span class="bu">file</span> <span class="kw">in</span> <span class="bu">enumerate</span>(files):</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="op">==</span> <span class="bu">len</span>(files) <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>              <span class="bu">print</span>(<span class="ss">f"        └── </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>:</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>              <span class="bu">print</span>(<span class="ss">f"        ├── </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(category_ids) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span><span class="bu">len</span>(category_ids) <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss"> more category_id folders..."</span>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>print_table_structure(<span class="st">'../../data/sql_almost/transaction_tbl'</span>,<span class="st">'category_id=1462446'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>transaction_tbl
  └── category_id=1462446
    └── behavior_type=buy
        ├── data_0.parquet
        ├── data_1.parquet
        ├── data_10.parquet
        ├── data_2.parquet
        ├── data_3.parquet
        ├── data_4.parquet
        ├── data_5.parquet
        ├── data_6.parquet
        ├── data_7.parquet
        ├── data_8.parquet
        └── data_9.parquet
    └── behavior_type=cart
        ├── data_0.parquet
        ├── data_1.parquet
        ├── data_10.parquet
        ├── data_2.parquet
        ├── data_3.parquet
        ├── data_4.parquet
        ├── data_5.parquet
        ├── data_6.parquet
        ├── data_7.parquet
        ├── data_8.parquet
        └── data_9.parquet
    └── behavior_type=fav
        ├── data_0.parquet
        ├── data_1.parquet
        ├── data_2.parquet
        ├── data_3.parquet
        ├── data_4.parquet
        ├── data_5.parquet
        ├── data_6.parquet
        └── data_7.parquet
    └── behavior_type=pv
        ├── data_0.parquet
        ├── data_1.parquet
        ├── data_10.parquet
        ├── data_2.parquet
        ├── data_3.parquet
        ├── data_4.parquet
        ├── data_5.parquet
        ├── data_6.parquet
        ├── data_7.parquet
        ├── data_8.parquet
        └── data_9.parquet
  7796 more category_id folders...</code></pre>
</div>
</div>
<p>To understand why specifying partitions is crucial, let us try our first query again and see how long it takes to run. We conduct 100 trials of 100 runs each to get mean and standard deviation of query time.</p>
<section id="example-who-are-the-users-that-viewed-item-2067266-run-without-partition-in-where-clause." class="level3">
<h3 class="anchored" data-anchor-id="example-who-are-the-users-that-viewed-item-2067266-run-without-partition-in-where-clause.">Example: Who are the users that viewed item 2067266? Run WITHOUT partition in <code>where</code> clause.</h3>
<div id="59741120" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="st">select distinct user_id from transaction_tbl</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="st">where item_id = 2067266;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>ts <span class="op">=</span> timeit.repeat(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">lambda</span>: execute_query(query),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  number<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  repeat<span class="op">=</span><span class="dv">100</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Query time WITHOUT partition: </span><span class="sc">{</span>np<span class="sc">.</span>mean(ts)<span class="sc">:.2f}</span><span class="ss">±</span><span class="sc">{</span>np<span class="sc">.</span>std(ts)<span class="sc">:.2f}</span><span class="ss"> seconds'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Query time WITHOUT partition: 0.15±0.08 seconds</code></pre>
</div>
</div>
</section>
<section id="example-who-are-the-users-that-viewed-item-2067266-run-with-category_id-partition-in-where-clause." class="level3">
<h3 class="anchored" data-anchor-id="example-who-are-the-users-that-viewed-item-2067266-run-with-category_id-partition-in-where-clause.">Example: Who are the users that viewed item 2067266? Run WITH <code>category_id</code> partition in <code>where</code> clause.</h3>
<div id="ab96d6b3" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="st">select distinct user_id from transaction_tbl</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="st">where item_id = 2067266</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="st"> and category_id = 4339722;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>ts <span class="op">=</span> timeit.repeat(</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">lambda</span>: execute_query(query),</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  number<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  repeat<span class="op">=</span><span class="dv">100</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Query time WITH partition: </span><span class="sc">{</span>np<span class="sc">.</span>mean(ts)<span class="sc">:.2f}</span><span class="ss">±</span><span class="sc">{</span>np<span class="sc">.</span>std(ts)<span class="sc">:.2f}</span><span class="ss"> seconds'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Query time WITH partition: 0.06±0.06 seconds</code></pre>
</div>
</div>
<p>What sorcery is this? The query time is roughly halved! This is because when we include partitions in the <code>where</code> clause, we are telling the query engine to <em>only look at the specific parts of the data</em> not the entire table. In real life, not specifying which partitions you need as detailed as possible can spell the difference between waiting for two hours or a few seconds.</p>
</section>
</section>
<section id="column-wise-manipulation" class="level2">
<h2 class="anchored" data-anchor-id="column-wise-manipulation">4. Column-wise Manipulation</h2>
<p>Before we move on, you might have noticed that our dataset is a little bland with only a timestamp and categorical columns (<code>timestamp</code>, <code>user_id</code>, <code>item_id</code>, <code>category_id</code>, <code>behavior_type</code>). In reality, such table as the one we are using often contains <code>price</code> of the item and <code>quantity</code> by which they were purchased. We can add that by manipulating existing columns.</p>
<section id="example-add-price-column-where-price-is-item_id-modulus-1000-50" class="level3">
<h3 class="anchored" data-anchor-id="example-add-price-column-where-price-is-item_id-modulus-1000-50">Example: Add <code>price</code> column where price is <code>item_id</code> modulus 1000 + 50</h3>
<p>Here we add the <code>price</code> column we randomly generated to the result. You can manipulate any numeric columns with <a href="https://www.geeksforgeeks.org/sql-arithmetic-operators/%5D">arithmetic operators</a>.</p>
<div id="360fb992" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id % 1000 + 50 as price</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>184439</td>
<td>688483</td>
<td>1512105722</td>
<td>buy</td>
<td>1000858</td>
<td>533</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>860167</td>
<td>3032030</td>
<td>1511876592</td>
<td>pv</td>
<td>1000858</td>
<td>80</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>29019</td>
<td>1174848</td>
<td>1511952716</td>
<td>pv</td>
<td>1000858</td>
<td>898</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999997</th>
<td>461462</td>
<td>1642299</td>
<td>1511677441</td>
<td>pv</td>
<td>999980</td>
<td>349</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4999998</th>
<td>891831</td>
<td>2064564</td>
<td>1512255716</td>
<td>pv</td>
<td>999980</td>
<td>614</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999999</th>
<td>10430</td>
<td>2006178</td>
<td>1512012994</td>
<td>pv</td>
<td>999980</td>
<td>228</td>
</tr>
</tbody>
</table>

<p>5000000 rows × 6 columns</p>
</div>
</div>
</div>
</section>
<section id="example-add-quantity-column-that-is-a-random-number-between-1-and-10-only-for-buy-events.-for-all-other-events-leave-it-as-missing-values-null." class="level3">
<h3 class="anchored" data-anchor-id="example-add-quantity-column-that-is-a-random-number-between-1-and-10-only-for-buy-events.-for-all-other-events-leave-it-as-missing-values-null.">Example: Add <code>quantity</code> column that is a random number between 1 and 10, only for <code>buy</code> events. For all other events, leave it as missing values (<code>null</code>).</h3>
<p>When you buy from a store, you need to specify a quantity of the items; however, for other events (when you view, favorite or add-to-cart), you do not. We must give the query engine an if-else logic depending on the values in each row. In SQL, we do this by using <code>case when [CONDITION] then [VALUE] else [DEFAULT VALUE] end</code>. We use <code>setseed</code> to keep the randomized numbers the same set.</p>
<div id="6dcf2d0a" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#random is randomizing number between 0 and 1 then floor rounds it down</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id % 1000 + 50 as price</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,case when behavior_type = 'buy' then FLOOR(RANDOM() * 10) + 1 else null end as quantity</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">quantity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>184439</td>
<td>688483</td>
<td>1512105722</td>
<td>buy</td>
<td>1000858</td>
<td>533</td>
<td>2.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>860167</td>
<td>3032030</td>
<td>1511876592</td>
<td>pv</td>
<td>1000858</td>
<td>80</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>29019</td>
<td>1174848</td>
<td>1511952716</td>
<td>pv</td>
<td>1000858</td>
<td>898</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999997</th>
<td>461462</td>
<td>1642299</td>
<td>1511677441</td>
<td>pv</td>
<td>999980</td>
<td>349</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4999998</th>
<td>891831</td>
<td>2064564</td>
<td>1512255716</td>
<td>pv</td>
<td>999980</td>
<td>614</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999999</th>
<td>10430</td>
<td>2006178</td>
<td>1512012994</td>
<td>pv</td>
<td>999980</td>
<td>228</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>5000000 rows × 7 columns</p>
</div>
</div>
</div>
<p>We can also have as many <code>when</code> as we want. If we want to explicitly state the conditions for all <code>behavior_type</code>, it will look something like:</p>
<div id="540aa603" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id % 1000 + 50 as price</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,case </span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="ss">   when behavior_type = 'buy' then FLOOR(RANDOM() * 10) + 1 </span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="ss">   when behavior_type = 'pv' then null</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="ss">   when behavior_type = 'cart' then null</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="ss">   when behavior_type = 'fav' then null</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="ss">   else null </span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="ss">  end as quantity</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">quantity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>184439</td>
<td>688483</td>
<td>1512105722</td>
<td>buy</td>
<td>1000858</td>
<td>533</td>
<td>4.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>860167</td>
<td>3032030</td>
<td>1511876592</td>
<td>pv</td>
<td>1000858</td>
<td>80</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>29019</td>
<td>1174848</td>
<td>1511952716</td>
<td>pv</td>
<td>1000858</td>
<td>898</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999997</th>
<td>461462</td>
<td>1642299</td>
<td>1511677441</td>
<td>pv</td>
<td>999980</td>
<td>349</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4999998</th>
<td>891831</td>
<td>2064564</td>
<td>1512255716</td>
<td>pv</td>
<td>999980</td>
<td>614</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999999</th>
<td>10430</td>
<td>2006178</td>
<td>1512012994</td>
<td>pv</td>
<td>999980</td>
<td>228</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>5000000 rows × 7 columns</p>
</div>
</div>
</div>
</section>
<section id="example-calculate-sales-by-multiplying-price-and-quantity" class="level3">
<h3 class="anchored" data-anchor-id="example-calculate-sales-by-multiplying-price-and-quantity">Example: Calculate <code>sales</code> by multiplying <code>price</code> and <code>quantity</code></h3>
<p>We can do operations among columns of the table. This example necessitates us to perform <code>select</code> twice: first to create <code>price</code> and <code>quantity</code>, then to create <code>sales</code> by multiplying them together. We do this by writing a subquery.</p>
<div id="a94bf415" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> whatever_subquery_alias_you_want.*</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,price * quantity as sales</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="ss">from </span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="ss">(select </span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id % 1000 + 50 as price</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,case when behavior_type = 'buy' then FLOOR(RANDOM() * 10) + 1 else null end as quantity</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl) whatever_subquery_alias_you_want;</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">quantity</th>
<th data-quarto-table-cell-role="th">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>184439</td>
<td>688483</td>
<td>1512105722</td>
<td>buy</td>
<td>1000858</td>
<td>533</td>
<td>6.0</td>
<td>3198.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>860167</td>
<td>3032030</td>
<td>1511876592</td>
<td>pv</td>
<td>1000858</td>
<td>80</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>29019</td>
<td>1174848</td>
<td>1511952716</td>
<td>pv</td>
<td>1000858</td>
<td>898</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999997</th>
<td>461462</td>
<td>1642299</td>
<td>1511677441</td>
<td>pv</td>
<td>999980</td>
<td>349</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4999998</th>
<td>891831</td>
<td>2064564</td>
<td>1512255716</td>
<td>pv</td>
<td>999980</td>
<td>614</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999999</th>
<td>10430</td>
<td>2006178</td>
<td>1512012994</td>
<td>pv</td>
<td>999980</td>
<td>228</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>5000000 rows × 8 columns</p>
</div>
</div>
</div>
<p>You would notice that the query becomes exponentially less readable with subqueries. This is especially the case when you have multiple nested subqueries and they become unreadable even by you in the next 3 months. An elegant solution is to separate these subqueries with <code>with</code> clauses. This is especially useful if you have a subquery you would like to reuse later in <em>the same query</em>. There is no performance difference between subqueries and <code>with</code> clauses, so pick what is easiest to read for you.</p>
<div id="e246a4a4" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="ss">with t1_tbl as (</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id % 1000 + 50 as price</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,case when behavior_type = 'buy' then FLOOR(RANDOM() * 10) + 1 else null end as quantity</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="ss">)</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,price * quantity as sales</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="ss">from t1_tbl;</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">quantity</th>
<th data-quarto-table-cell-role="th">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>184439</td>
<td>688483</td>
<td>1512105722</td>
<td>buy</td>
<td>1000858</td>
<td>533</td>
<td>6.0</td>
<td>3198.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>860167</td>
<td>3032030</td>
<td>1511876592</td>
<td>pv</td>
<td>1000858</td>
<td>80</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>29019</td>
<td>1174848</td>
<td>1511952716</td>
<td>pv</td>
<td>1000858</td>
<td>898</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999997</th>
<td>461462</td>
<td>1642299</td>
<td>1511677441</td>
<td>pv</td>
<td>999980</td>
<td>349</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4999998</th>
<td>891831</td>
<td>2064564</td>
<td>1512255716</td>
<td>pv</td>
<td>999980</td>
<td>614</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999999</th>
<td>10430</td>
<td>2006178</td>
<td>1512012994</td>
<td>pv</td>
<td>999980</td>
<td>228</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>5000000 rows × 8 columns</p>
</div>
</div>
</div>
</section>
<section id="example-fill-in-missing-values-in-sales-with-zero." class="level3">
<h3 class="anchored" data-anchor-id="example-fill-in-missing-values-in-sales-with-zero.">Example: Fill in missing values in <code>sales</code> with zero.</h3>
<p>We use <code>coalesce</code> to fill in missing values. Notice that we can have multiple <code>with</code> clauses (consecutive ones puncutated by <code>,</code> and do not need <code>with</code>) depending on how you thin is most readable.</p>
<div id="6779ae4f" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="ss">with t1_tbl as (</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id % 1000 + 50 as price</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,case when behavior_type = 'buy' then FLOOR(RANDOM() * 10) + 1 else null end as quantity</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="ss">),</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="ss">t2_tbl as (</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,price * quantity as sales</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="ss">from t1_tbl</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="ss">)</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,timestamp</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,behavior_type</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,category_id</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,price</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,quantity</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,coalesce(sales, 0) as sales</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="ss">from t2_tbl;</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">quantity</th>
<th data-quarto-table-cell-role="th">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>184439</td>
<td>688483</td>
<td>1512105722</td>
<td>buy</td>
<td>1000858</td>
<td>533</td>
<td>2.0</td>
<td>1066.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>860167</td>
<td>3032030</td>
<td>1511876592</td>
<td>pv</td>
<td>1000858</td>
<td>80</td>
<td>NaN</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>29019</td>
<td>1174848</td>
<td>1511952716</td>
<td>pv</td>
<td>1000858</td>
<td>898</td>
<td>NaN</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999997</th>
<td>461462</td>
<td>1642299</td>
<td>1511677441</td>
<td>pv</td>
<td>999980</td>
<td>349</td>
<td>NaN</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4999998</th>
<td>891831</td>
<td>2064564</td>
<td>1512255716</td>
<td>pv</td>
<td>999980</td>
<td>614</td>
<td>NaN</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999999</th>
<td>10430</td>
<td>2006178</td>
<td>1512012994</td>
<td>pv</td>
<td>999980</td>
<td>228</td>
<td>NaN</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<p>5000000 rows × 8 columns</p>
</div>
</div>
</div>
</section>
<section id="example-convert-timestamp-from-unix-timestamp-to-yyyy-mm-dd-format." class="level3">
<h3 class="anchored" data-anchor-id="example-convert-timestamp-from-unix-timestamp-to-yyyy-mm-dd-format.">Example: Convert timestamp from unix timestamp to <code>yyyy-mm-dd</code> format.</h3>
<p>Datetime conversion, as in any programming script, is a very confusing affair, so I highly recommend you refer to your specific SQL’s documentation such as <a href="https://spark.apache.org/docs/latest/sql-ref-datetime-pattern.html">this one for Spark</a>. But the idea is simply applying some function over your columns. Here we use <code>to_timestamp</code> to convert from <code>int</code> to unix timestamp and then use <code>strftime</code> to convert to a string formatted as <code>yyyy-mm-dd</code>.</p>
<div id="0a09739d" class="cell" data-execution_count="25">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="ss">with t1_tbl as (</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id % 1000 + 50 as price</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,case when behavior_type = 'buy' then FLOOR(RANDOM() * 10) + 1 else null end as quantity</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="ss">),</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="ss">t2_tbl as (</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,price * quantity as sales</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="ss">from t1_tbl</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="ss">),</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="ss">t3_tbl as (</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,timestamp</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,behavior_type</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,category_id</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,price</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,quantity</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,coalesce(sales, 0) as sales</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="ss">from t2_tbl)</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,to_timestamp(timestamp) as event_timestamp</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,strftime(to_timestamp(timestamp), '%Y-%m-%d') as event_date</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="ss">from t3_tbl;</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">quantity</th>
<th data-quarto-table-cell-role="th">sales</th>
<th data-quarto-table-cell-role="th">event_timestamp</th>
<th data-quarto-table-cell-role="th">event_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>184439</td>
<td>688483</td>
<td>1512105722</td>
<td>buy</td>
<td>1000858</td>
<td>533</td>
<td>5.0</td>
<td>2665.0</td>
<td>2017-12-01 14:22:02+09:00</td>
<td>2017-12-01</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>860167</td>
<td>3032030</td>
<td>1511876592</td>
<td>pv</td>
<td>1000858</td>
<td>80</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-28 22:43:12+09:00</td>
<td>2017-11-28</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>29019</td>
<td>1174848</td>
<td>1511952716</td>
<td>pv</td>
<td>1000858</td>
<td>898</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-29 19:51:56+09:00</td>
<td>2017-11-29</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999997</th>
<td>461462</td>
<td>1642299</td>
<td>1511677441</td>
<td>pv</td>
<td>999980</td>
<td>349</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-26 15:24:01+09:00</td>
<td>2017-11-26</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4999998</th>
<td>891831</td>
<td>2064564</td>
<td>1512255716</td>
<td>pv</td>
<td>999980</td>
<td>614</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-03 08:01:56+09:00</td>
<td>2017-12-03</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999999</th>
<td>10430</td>
<td>2006178</td>
<td>1512012994</td>
<td>pv</td>
<td>999980</td>
<td>228</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-30 12:36:34+09:00</td>
<td>2017-11-30</td>
</tr>
</tbody>
</table>

<p>5000000 rows × 10 columns</p>
</div>
</div>
</div>
</section>
<section id="example-make-a-string-column-year_month-that-takes-only-the-yyyy-mm-part-from-event_timestamp." class="level3">
<h3 class="anchored" data-anchor-id="example-make-a-string-column-year_month-that-takes-only-the-yyyy-mm-part-from-event_timestamp.">Example: Make a string column <code>year_month</code> that takes only the <code>yyyy-mm</code> part from <code>event_timestamp</code>.</h3>
<p>Most query engines have built-in functions to manipulate texts such as <a href="https://duckdb.org/docs/stable/sql/functions/text.html">this one for duckdb</a>. However, in this case, since <code>event_timestamp</code> is a timestmap, we need to convert its data type to string before applying the function <code>substring</code> by using <code>cast([COLUMN] as [DATA TYPE])</code>.</p>
<div id="af7584e4" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ss">with t1_tbl as (</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id % 1000 + 50 as price</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,case when behavior_type = 'buy' then FLOOR(RANDOM() * 10) + 1 else null end as quantity</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="ss">),</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="ss">t2_tbl as (</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,price * quantity as sales</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="ss">from t1_tbl</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="ss">),</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="ss">t3_tbl as (</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,timestamp</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,behavior_type</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,category_id</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,price</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,quantity</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,coalesce(sales, 0) as sales</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="ss">from t2_tbl),</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="ss">t4_tbl as (</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,to_timestamp(timestamp) as event_timestamp</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,strftime(to_timestamp(timestamp), '%Y-%m-%d') as event_date</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a><span class="ss">from t3_tbl)</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,substring(cast(event_timestamp as varchar),1,7) as year_month</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="ss">from t4_tbl;</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">quantity</th>
<th data-quarto-table-cell-role="th">sales</th>
<th data-quarto-table-cell-role="th">event_timestamp</th>
<th data-quarto-table-cell-role="th">event_date</th>
<th data-quarto-table-cell-role="th">year_month</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>184439</td>
<td>688483</td>
<td>1512105722</td>
<td>buy</td>
<td>1000858</td>
<td>533</td>
<td>5.0</td>
<td>2665.0</td>
<td>2017-12-01 14:22:02+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>860167</td>
<td>3032030</td>
<td>1511876592</td>
<td>pv</td>
<td>1000858</td>
<td>80</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-28 22:43:12+09:00</td>
<td>2017-11-28</td>
<td>2017-11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>29019</td>
<td>1174848</td>
<td>1511952716</td>
<td>pv</td>
<td>1000858</td>
<td>898</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-29 19:51:56+09:00</td>
<td>2017-11-29</td>
<td>2017-11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999997</th>
<td>461462</td>
<td>1642299</td>
<td>1511677441</td>
<td>pv</td>
<td>999980</td>
<td>349</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-26 15:24:01+09:00</td>
<td>2017-11-26</td>
<td>2017-11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4999998</th>
<td>891831</td>
<td>2064564</td>
<td>1512255716</td>
<td>pv</td>
<td>999980</td>
<td>614</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-03 08:01:56+09:00</td>
<td>2017-12-03</td>
<td>2017-12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4999999</th>
<td>10430</td>
<td>2006178</td>
<td>1512012994</td>
<td>pv</td>
<td>999980</td>
<td>228</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-30 12:36:34+09:00</td>
<td>2017-11-30</td>
<td>2017-11</td>
</tr>
</tbody>
</table>

<p>5000000 rows × 11 columns</p>
</div>
</div>
</div>
</section>
<section id="example-save-the-manipulations-done-so-far-as-a-view-to-be-used-later." class="level3">
<h3 class="anchored" data-anchor-id="example-save-the-manipulations-done-so-far-as-a-view-to-be-used-later.">Example: Save the manipulations done so far as a <code>view</code> to be used later.</h3>
<p>You’ll notice that even with the <code>with</code> clauses, our query seems substantially more clunky now. We do not want to be re-writing these lines every time we reuse this set of results for other queries. Luckily, there is a solution called <code>view</code>. A view saves the query logic that can be used for other queries later. Unlike actual SQL tables, the data are not stored physically on your database, so the query saved to a view will still run every time it is called.</p>
<p>This query creates the view:</p>
<div id="d5b3d29b" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="ss">create or replace view transaction_tbl_x as (</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="ss">with t1_tbl as (</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id % 1000 + 50 as price</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,case when behavior_type = 'buy' then FLOOR(RANDOM() * 10) + 1 else null end as quantity</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="ss">),</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="ss">t2_tbl as (</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,price * quantity as sales</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="ss">from t1_tbl</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="ss">),</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="ss">t3_tbl as (</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,timestamp</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,behavior_type</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,category_id</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,price</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,quantity</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,coalesce(sales, 0) as sales</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="ss">from t2_tbl),</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="ss">t4_tbl as (</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,to_timestamp(timestamp) as event_timestamp</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,strftime(to_timestamp(timestamp), '%Y-%m-%d') as event_date</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a><span class="ss">from t3_tbl)</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,substring(cast(event_timestamp as varchar),1,7) as year_month</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a><span class="ss">from t4_tbl</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="ss">)</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Count</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
<p>This query reuses it by a simple <code>select *</code>:</p>
<div id="24e4367d" class="cell" data-execution_count="28">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select * from transaction_tbl_x limit 100;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">quantity</th>
<th data-quarto-table-cell-role="th">sales</th>
<th data-quarto-table-cell-role="th">event_timestamp</th>
<th data-quarto-table-cell-role="th">event_date</th>
<th data-quarto-table-cell-role="th">year_month</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>184439</td>
<td>688483</td>
<td>1512105722</td>
<td>buy</td>
<td>1000858</td>
<td>533</td>
<td>5.0</td>
<td>2665.0</td>
<td>2017-12-01 14:22:02+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>860167</td>
<td>3032030</td>
<td>1511876592</td>
<td>pv</td>
<td>1000858</td>
<td>80</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-28 22:43:12+09:00</td>
<td>2017-11-28</td>
<td>2017-11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>29019</td>
<td>1174848</td>
<td>1511952716</td>
<td>pv</td>
<td>1000858</td>
<td>898</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-29 19:51:56+09:00</td>
<td>2017-11-29</td>
<td>2017-11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">97</th>
<td>109393</td>
<td>336502</td>
<td>1512302682</td>
<td>pv</td>
<td>1003726</td>
<td>552</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-03 21:04:42+09:00</td>
<td>2017-12-03</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">98</th>
<td>928768</td>
<td>2826670</td>
<td>1511780591</td>
<td>pv</td>
<td>1003726</td>
<td>720</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-27 20:03:11+09:00</td>
<td>2017-11-27</td>
<td>2017-11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">99</th>
<td>719622</td>
<td>2297792</td>
<td>1511703912</td>
<td>pv</td>
<td>1003726</td>
<td>842</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-26 22:45:12+09:00</td>
<td>2017-11-26</td>
<td>2017-11</td>
</tr>
</tbody>
</table>

<p>100 rows × 11 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="aggregation-aka-group-by" class="level2">
<h2 class="anchored" data-anchor-id="aggregation-aka-group-by">5. Aggregation aka Group By</h2>
<p>When you have millions of rows of data, you do not want to look at them one by one; you want to know how they appear in aggregateーhow many events there are for each type, which items are favorited the most/least, how many items users buy on average, and so on. In fact, you have already learned how to do some of this. <code>count</code> and <code>count(distinct [COLUMN])</code> are examples of aggregation over the entire table. In this section, we will also learn to use <code>group by</code> to get aggregated values according to the columns we want.</p>
<section id="example-how-many-events-are-there-for-each-event-type-behavior_type" class="level3">
<h3 class="anchored" data-anchor-id="example-how-many-events-are-there-for-each-event-type-behavior_type">Example: How many events are there for each event type (<code>behavior_type</code>)?</h3>
<p>You can order by the newly created <code>nb_event</code> column to sort event types in descending order according to how many events they have. As expected, it is views, add-to-carts, favorites, then purchases.</p>
<div id="32510a06" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> behavior_type</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,count(*) as nb_event</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="ss">group by behavior_type</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="ss">order by nb_event desc;</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">nb_event</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>pv</td>
<td>4478549</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>cart</td>
<td>276307</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>fav</td>
<td>144452</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>buy</td>
<td>100692</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>One neat trick is that you do not have to write the column names in <code>group by</code> or <code>order by</code> and use numbering instead; for instance, 1 means the first column selected, in this case <code>behavior_type</code>.</p>
<div id="f6b41d05" class="cell" data-execution_count="30">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> behavior_type</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,count(*) as nb_event</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="ss">order by 2 desc;</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">nb_event</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>pv</td>
<td>4478549</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>cart</td>
<td>276307</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>fav</td>
<td>144452</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>buy</td>
<td>100692</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-what-are-the-top-10-items-that-got-favorited-by-most-number-of-unique-customers" class="level3">
<h3 class="anchored" data-anchor-id="example-what-are-the-top-10-items-that-got-favorited-by-most-number-of-unique-customers">Example: What are the top 10 items that got favorited by most number of unique customers?</h3>
<p>When used in conjunction with <code>where</code>, the <code>where</code> clause comes before <code>group by</code>.</p>
<div id="e9eebc5e" class="cell" data-execution_count="31">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> item_id</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,count(distinct user_id) as nb_user</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'fav'</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="ss">order by 2 desc</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="ss">limit 10;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="31">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">nb_user</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2331370</td>
<td>43</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>3845720</td>
<td>41</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2279428</td>
<td>40</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">7</th>
<td>2364679</td>
<td>37</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">8</th>
<td>3403645</td>
<td>35</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">9</th>
<td>1783990</td>
<td>33</td>
</tr>
</tbody>
</table>

<p>10 rows × 2 columns</p>
</div>
</div>
</div>
</section>
<section id="example-what-is-the-average-standard-deviation-min-and-max-spend-per-user" class="level3">
<h3 class="anchored" data-anchor-id="example-what-is-the-average-standard-deviation-min-and-max-spend-per-user">Example: What is the average, standard deviation, min, and max spend per user?</h3>
<p>First, we need to <code>sum</code> up all <code>sales</code> for each user then perform the <code>avg</code>, <code>stddev</code>, <code>min</code> and <code>max</code> aggregation over all users. We can also see quantiles using functions like <code>approx_quantile([COLUMN], [QUANTILE])</code>.</p>
<div id="012d8108" class="cell" data-execution_count="32">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> min(spend) as min_spend</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,approx_quantile(spend, 0.25) as p25</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,avg(spend) as avg_spend</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,stddev(spend) as std_spend</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,approx_quantile(spend, 0.5) as p50</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,approx_quantile(spend, 0.75) as p75</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,max(spend) as max_spend</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="ss">from</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="ss">(select </span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,sum(sales) as spend</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="ss">) a;</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="32">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">min_spend</th>
<th data-quarto-table-cell-role="th">p25</th>
<th data-quarto-table-cell-role="th">avg_spend</th>
<th data-quarto-table-cell-role="th">std_spend</th>
<th data-quarto-table-cell-role="th">p50</th>
<th data-quarto-table-cell-role="th">p75</th>
<th data-quarto-table-cell-role="th">max_spend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0.0</td>
<td>0.0</td>
<td>343.119825</td>
<td>1343.99162</td>
<td>0.0</td>
<td>0.0</td>
<td>33513.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-how-many-percentage-of-customer-purchased-at-least-once" class="level3">
<h3 class="anchored" data-anchor-id="example-how-many-percentage-of-customer-purchased-at-least-once">Example: How many percentage of customer purchased at least once?</h3>
<p>As you might notice from the last example, most of the customers have spend equals zero. This is a typical distribution in a retail business where most users come to window shop and only a few will make a purchase. We can find out % of those who made at least one purchase by combining <code>avg</code> aggregation and the <code>case when</code> if-else logic.</p>
<div id="212bcf8f" class="cell" data-execution_count="33">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> avg(case when spend &gt; 0 then 1 else 0 end) as conversion_rate</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="ss">from</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="ss">(select </span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,sum(sales) as spend</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="ss">) a;</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">conversion_rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0.102035</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-give-me-only-customers-who-have-bought-at-least-one-item-more-expensive-than-100." class="level3">
<h3 class="anchored" data-anchor-id="example-give-me-only-customers-who-have-bought-at-least-one-item-more-expensive-than-100.">Example: Give me only customers who have bought at least one item more expensive than $100.</h3>
<p>In the same manner we use <code>where</code> clause to filter <code>select</code>, we can also use <code>having</code> to filter aggregations. This works exactly the same where as how you would do aggregation first then filter it with a subquery. Most modern query engines treat them the same way in terms of performance so pick whichever is more readable to you.</p>
<div id="f9c3e3be" class="cell" data-execution_count="34">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,min(price) as min_price</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'buy'</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="ss">having min_price &gt; 100</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="ss">order by min_price;</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">min_price</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>782669</td>
<td>101</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>302287</td>
<td>101</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>773094</td>
<td>101</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">85577</th>
<td>340274</td>
<td>1049</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">85578</th>
<td>603498</td>
<td>1049</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">85579</th>
<td>438867</td>
<td>1049</td>
</tr>
</tbody>
</table>

<p>85580 rows × 2 columns</p>
</div>
</div>
</div>
</section>
<section id="example-for-each-user-who-have-favorited-anything-give-me-a-list-of-items-they-have-favorited-ordered-by-timestamp-in-ascending-order." class="level3">
<h3 class="anchored" data-anchor-id="example-for-each-user-who-have-favorited-anything-give-me-a-list-of-items-they-have-favorited-ordered-by-timestamp-in-ascending-order.">Example: For each user who have favorited anything, give me a list of items they have favorited ordered by timestamp in ascending order.</h3>
<p>Today you might run into preparing a sequence dataset to train LLMs, in which case you want to concatenate a series of values from a column. Most modern SQL handles this such as <a href="https://spark.apache.org/docs/latest/sql-ref-functions-builtin.html#array-functions">Spark SQL</a> and <a href="https://prestodb.io/docs/current/functions/array.html">Presto</a>. In duckdb, we can use <code>string_agg</code> and keep order from earliest to latest timestamp by using <code>order by</code>.</p>
<div id="c3582d76" class="cell" data-execution_count="35">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,string_agg(item_id order by timestamp) as item_id_list</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'fav'</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id_list</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>744534</td>
<td>2149136,88810,4629792</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>517461</td>
<td>4325698,5109079,2036947</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>261004</td>
<td>1289993,4431704</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">98434</th>
<td>702058</td>
<td>4753515</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">98435</th>
<td>865408</td>
<td>2643630</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">98436</th>
<td>391171</td>
<td>5154868</td>
</tr>
</tbody>
</table>

<p>98437 rows × 2 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="window-function" class="level2">
<h2 class="anchored" data-anchor-id="window-function">6. Window Function</h2>
<p>Aggregation is very powerful, but a major downside is that it collapses the total rows into aggregated values. This means that after using <code>group by</code>, you lose the individual detail of each original row. You can no longer easily ask questions about the sequence of events, like “What happened just before this?” or “What is the third item in this list?”. Window functions solve this by allowing you to perform calculations on a related set of rows (a “window”) without making those rows disappear. They let you calculate things like rankings, running totals, or compare values across rows, all while keeping all your original data rows intact.</p>
<section id="example-for-each-user-find-their-second-to-last-event." class="level3">
<h3 class="anchored" data-anchor-id="example-for-each-user-find-their-second-to-last-event.">Example: For each user, find their second-to-last event.</h3>
<p>We might be able to use <code>min/max</code> aggregation with some subqueries to get the last event, but second-to-last event is a bit convoluted to retrieve with <code>group by</code> alone. This is trivial when we use <code>row_number() over (partition by [WINDOW COLUMN] order by [ORDERING COLUMN] asc/desc)</code> to get the ranking numbers (starting with 1), then filter only the rows we need (<code>rnk=2</code>).</p>
<div id="e6814a5d" class="cell" data-execution_count="36">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select * from</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="ss">(select </span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,row_number() over (partition by user_id order by timestamp desc) as rnk</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x) a</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="ss">where rnk=2</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">quantity</th>
<th data-quarto-table-cell-role="th">sales</th>
<th data-quarto-table-cell-role="th">event_timestamp</th>
<th data-quarto-table-cell-role="th">event_date</th>
<th data-quarto-table-cell-role="th">year_month</th>
<th data-quarto-table-cell-role="th">rnk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>6</td>
<td>730246</td>
<td>1512151025</td>
<td>pv</td>
<td>4756105</td>
<td>296</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-02 02:57:05+09:00</td>
<td>2017-12-02</td>
<td>2017-12</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>58</td>
<td>274807</td>
<td>1512191821</td>
<td>pv</td>
<td>4458428</td>
<td>857</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-02 14:17:01+09:00</td>
<td>2017-12-02</td>
<td>2017-12</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>73</td>
<td>2561888</td>
<td>1512224052</td>
<td>pv</td>
<td>753984</td>
<td>938</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-02 23:14:12+09:00</td>
<td>2017-12-02</td>
<td>2017-12</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">753406</th>
<td>1017789</td>
<td>797757</td>
<td>1512179970</td>
<td>pv</td>
<td>883960</td>
<td>807</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-02 10:59:30+09:00</td>
<td>2017-12-02</td>
<td>2017-12</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">753407</th>
<td>1017827</td>
<td>4777442</td>
<td>1512258856</td>
<td>pv</td>
<td>3607361</td>
<td>492</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-03 08:54:16+09:00</td>
<td>2017-12-03</td>
<td>2017-12</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">753408</th>
<td>1017858</td>
<td>850224</td>
<td>1512291735</td>
<td>pv</td>
<td>3800818</td>
<td>274</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-03 18:02:15+09:00</td>
<td>2017-12-03</td>
<td>2017-12</td>
<td>2</td>
</tr>
</tbody>
</table>

<p>753409 rows × 12 columns</p>
</div>
</div>
</div>
<p>We can confirm that these are one second-to-last event each from users who have a least 2 events.</p>
<div id="311c309b" class="cell" data-execution_count="37">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select count(*) from</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="ss">(select </span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,count(*) nb</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1) a</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="ss">where nb&gt;=2</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="37">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count_star()</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>753409</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-what-is-the-first-item-in-each-category-that-each-user-view" class="level3">
<h3 class="anchored" data-anchor-id="example-what-is-the-first-item-in-each-category-that-each-user-view">Example: What is the first item in each category that each user view?</h3>
<p>We can also have multiple partitions as window.</p>
<div id="4eea2b0b" class="cell" data-execution_count="38">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select * from</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="ss">(select </span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_id</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,row_number() over (partition by user_id, category_id order by timestamp asc) as rnk</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'pv') a</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="ss">where rnk=1;</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">rnk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>7</td>
<td>516760</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>19</td>
<td>3615870</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>21</td>
<td>4928897</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3389298</th>
<td>1017999</td>
<td>3251062</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3389299</th>
<td>1018006</td>
<td>2789562</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3389300</th>
<td>1018011</td>
<td>3190817</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>3389301 rows × 3 columns</p>
</div>
</div>
</div>
</section>
<section id="example-for-each-user-what-was-their-previous-action-before-a-buy-action" class="level3">
<h3 class="anchored" data-anchor-id="example-for-each-user-what-was-their-previous-action-before-a-buy-action">Example: For each user, what was their previous action before a <code>buy</code> action?</h3>
<p>We can use <code>lag/lead</code> to get value just before or after each row.</p>
<div id="20f59cfd" class="cell" data-execution_count="39">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">10</span>) </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="ss">select * from </span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="ss">(select</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="ss">    user_id,</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="ss">    event_timestamp,</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="ss">    behavior_type as current_event,</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="ss">    lag(behavior_type) over (partition by user_id order by event_timestamp asc) as previous_event</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="ss">order by user_id, event_timestamp asc) a</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="ss">where current_event = 'buy'</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="ss">limit 10</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="39">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">event_timestamp</th>
<th data-quarto-table-cell-role="th">current_event</th>
<th data-quarto-table-cell-role="th">previous_event</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>2017-12-02 20:34:34+09:00</td>
<td>buy</td>
<td>pv</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>41</td>
<td>2017-11-28 15:22:28+09:00</td>
<td>buy</td>
<td>pv</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>45</td>
<td>2017-12-03 11:49:02+09:00</td>
<td>buy</td>
<td>pv</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>50</td>
<td>2017-11-27 09:02:55+09:00</td>
<td>buy</td>
<td>None</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>50</td>
<td>2017-12-02 11:35:55+09:00</td>
<td>buy</td>
<td>pv</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>50</td>
<td>2017-12-03 20:56:57+09:00</td>
<td>buy</td>
<td>buy</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>59</td>
<td>2017-11-27 01:29:32+09:00</td>
<td>buy</td>
<td>pv</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>62</td>
<td>2017-12-03 16:30:30+09:00</td>
<td>buy</td>
<td>pv</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>68</td>
<td>2017-11-27 19:59:34+09:00</td>
<td>buy</td>
<td>pv</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>80</td>
<td>2017-11-25 22:52:00+09:00</td>
<td>buy</td>
<td>pv</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Confirm the query works by looking at <code>user_id=50</code> (no event, <code>pv</code>, <code>buy</code>) and <code>user_id=41</code> (single <code>pv</code> event).</p>
<div id="eb5801bf" class="cell" data-execution_count="40">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">30</span>) </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> *</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="ss">where user_id in (50, 41)</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="ss">order by user_id, event_timestamp</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">behavior_type</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">quantity</th>
<th data-quarto-table-cell-role="th">sales</th>
<th data-quarto-table-cell-role="th">event_timestamp</th>
<th data-quarto-table-cell-role="th">event_date</th>
<th data-quarto-table-cell-role="th">year_month</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>41</td>
<td>2350782</td>
<td>1511590506</td>
<td>fav</td>
<td>3576283</td>
<td>832</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-25 15:15:06+09:00</td>
<td>2017-11-25</td>
<td>2017-11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>41</td>
<td>4810522</td>
<td>1511592979</td>
<td>pv</td>
<td>1464116</td>
<td>572</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-25 15:56:19+09:00</td>
<td>2017-11-25</td>
<td>2017-11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>41</td>
<td>259923</td>
<td>1511651601</td>
<td>pv</td>
<td>4170419</td>
<td>973</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-26 08:13:21+09:00</td>
<td>2017-11-26</td>
<td>2017-11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>41</td>
<td>4786486</td>
<td>1511758455</td>
<td>pv</td>
<td>2572604</td>
<td>536</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-27 13:54:15+09:00</td>
<td>2017-11-27</td>
<td>2017-11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>41</td>
<td>460114</td>
<td>1511850148</td>
<td>buy</td>
<td>4804883</td>
<td>164</td>
<td>5.0</td>
<td>820.0</td>
<td>2017-11-28 15:22:28+09:00</td>
<td>2017-11-28</td>
<td>2017-11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>41</td>
<td>1876500</td>
<td>1511850397</td>
<td>pv</td>
<td>3158249</td>
<td>550</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-28 15:26:37+09:00</td>
<td>2017-11-28</td>
<td>2017-11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>41</td>
<td>3599288</td>
<td>1512050217</td>
<td>cart</td>
<td>1537669</td>
<td>338</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-30 22:56:57+09:00</td>
<td>2017-11-30</td>
<td>2017-11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>41</td>
<td>2479959</td>
<td>1512050346</td>
<td>pv</td>
<td>3491350</td>
<td>1009</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-30 22:59:06+09:00</td>
<td>2017-11-30</td>
<td>2017-11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>41</td>
<td>3095445</td>
<td>1512072759</td>
<td>fav</td>
<td>4801426</td>
<td>495</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-01 05:12:39+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>41</td>
<td>3937435</td>
<td>1512072770</td>
<td>pv</td>
<td>4801426</td>
<td>485</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-01 05:12:50+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>41</td>
<td>2601044</td>
<td>1512073082</td>
<td>pv</td>
<td>2735466</td>
<td>94</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-01 05:18:02+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>41</td>
<td>3017816</td>
<td>1512073131</td>
<td>pv</td>
<td>2735466</td>
<td>866</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-01 05:18:51+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>41</td>
<td>3976745</td>
<td>1512073512</td>
<td>pv</td>
<td>3002561</td>
<td>795</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-01 05:25:12+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>50</td>
<td>1808993</td>
<td>1511740975</td>
<td>buy</td>
<td>4690421</td>
<td>1043</td>
<td>10.0</td>
<td>10430.0</td>
<td>2017-11-27 09:02:55+09:00</td>
<td>2017-11-27</td>
<td>2017-11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>50</td>
<td>1353441</td>
<td>1511743131</td>
<td>cart</td>
<td>64179</td>
<td>491</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-27 09:38:51+09:00</td>
<td>2017-11-27</td>
<td>2017-11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>50</td>
<td>1963474</td>
<td>1511743387</td>
<td>pv</td>
<td>3422001</td>
<td>524</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-27 09:43:07+09:00</td>
<td>2017-11-27</td>
<td>2017-11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>50</td>
<td>972172</td>
<td>1511854245</td>
<td>pv</td>
<td>4756105</td>
<td>222</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-28 16:30:45+09:00</td>
<td>2017-11-28</td>
<td>2017-11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>50</td>
<td>407777</td>
<td>1511948105</td>
<td>pv</td>
<td>4756105</td>
<td>827</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-11-29 18:35:05+09:00</td>
<td>2017-11-29</td>
<td>2017-11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>50</td>
<td>2559047</td>
<td>1512108229</td>
<td>pv</td>
<td>4756105</td>
<td>97</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-01 15:03:49+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td>50</td>
<td>3408121</td>
<td>1512110060</td>
<td>pv</td>
<td>1320293</td>
<td>171</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-01 15:34:20+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>50</td>
<td>4225949</td>
<td>1512110662</td>
<td>pv</td>
<td>1879194</td>
<td>999</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-01 15:44:22+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>50</td>
<td>1820775</td>
<td>1512112710</td>
<td>cart</td>
<td>4537973</td>
<td>825</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-01 16:18:30+09:00</td>
<td>2017-12-01</td>
<td>2017-12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>50</td>
<td>3096190</td>
<td>1512179808</td>
<td>pv</td>
<td>472273</td>
<td>240</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-02 10:56:48+09:00</td>
<td>2017-12-02</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td>50</td>
<td>5155205</td>
<td>1512179846</td>
<td>cart</td>
<td>4762182</td>
<td>255</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-02 10:57:26+09:00</td>
<td>2017-12-02</td>
<td>2017-12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>50</td>
<td>518956</td>
<td>1512181946</td>
<td>pv</td>
<td>4835206</td>
<td>1006</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-02 11:32:26+09:00</td>
<td>2017-12-02</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>50</td>
<td>120958</td>
<td>1512182155</td>
<td>buy</td>
<td>4762182</td>
<td>1008</td>
<td>3.0</td>
<td>3024.0</td>
<td>2017-12-02 11:35:55+09:00</td>
<td>2017-12-02</td>
<td>2017-12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>50</td>
<td>4619331</td>
<td>1512302217</td>
<td>buy</td>
<td>3884119</td>
<td>381</td>
<td>7.0</td>
<td>2667.0</td>
<td>2017-12-03 20:56:57+09:00</td>
<td>2017-12-03</td>
<td>2017-12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>50</td>
<td>5045605</td>
<td>1512302237</td>
<td>pv</td>
<td>820727</td>
<td>655</td>
<td>NaN</td>
<td>0.0</td>
<td>2017-12-03 20:57:17+09:00</td>
<td>2017-12-03</td>
<td>2017-12</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-what-is-the-contribution-of-each-item-to-their-overall-category-sales" class="level3">
<h3 class="anchored" data-anchor-id="example-what-is-the-contribution-of-each-item-to-their-overall-category-sales">Example: What is the contribution of each item to their overall category sales?</h3>
<p>We can also use aggregations like <code>sum</code> in conjuction with window function.</p>
<div id="b4d5b2c9" class="cell" data-execution_count="41">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">6</span>) </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> item_id</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,category_id</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,item_sales / category_sales as percentage_category_sales</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="ss">from (</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="ss">  select</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="ss">   item_id</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="ss">   ,category_id</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="ss">   ,item_sales</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="ss">   ,sum(item_sales) over (partition by category_id) as category_sales</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="ss">  from (</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="ss">   select</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="ss">    item_id</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="ss">    ,category_id</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="ss">    ,sum(sales) as item_sales</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a><span class="ss">    from transaction_tbl_x</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a><span class="ss">    group by 1,2</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="ss">  ) a</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a><span class="ss">) b</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="ss">where category_sales &gt; 0;</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">category_id</th>
<th data-quarto-table-cell-role="th">percentage_category_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>644316</td>
<td>75275</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>4356670</td>
<td>75275</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>45889</td>
<td>75275</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1219659</th>
<td>4607802</td>
<td>5078340</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1219660</th>
<td>4052466</td>
<td>5078340</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1219661</th>
<td>104515</td>
<td>5078340</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<p>1219662 rows × 3 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="concatenation-aka-union" class="level2">
<h2 class="anchored" data-anchor-id="concatenation-aka-union">7. Concatenation aka Union</h2>
<p>Sometimes you want to concatenate multiple tables with the same set of columns (called schema) together. <code>union all</code> is simple concatenation whereas <code>union</code> will also deduplicate the rows for you, only returning rows that are not perfectly identical to one another.</p>
<section id="example-concatenate-monthly-summary-of-2017-11-and-2017-12-together." class="level3">
<h3 class="anchored" data-anchor-id="example-concatenate-monthly-summary-of-2017-11-and-2017-12-together.">Example: Concatenate monthly summary of <code>2017-11</code> and <code>2017-12</code> together.</h3>
<p>We do not need to worry about duplicates here so we can simply use <code>union all</code>. See how we can combine <code>count</code>, <code>distinct</code> and <code>case when</code> to get monthly acitve customers and purchasers.</p>
<div id="1b5f8dfb" class="cell" data-execution_count="42">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select * from</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="ss">(select </span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> year_month</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,count(distinct user_id) as nb_active_customer</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,count(distinct case when behavior_type='buy' then user_id else null end) as nb_purchaser</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,sum(sales) as total_sales</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="ss">where year_month = '2017-11'</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1)</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="ss">union all</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="ss">(select </span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="ss"> year_month</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,count(distinct user_id) as nb_active_customer</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,count(distinct case when behavior_type='buy' then user_id else null end) as nb_purchaser</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,sum(sales) as total_sales</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="ss">where year_month = '2017-12'</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1);</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="42">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">year_month</th>
<th data-quarto-table-cell-role="th">nb_active_customer</th>
<th data-quarto-table-cell-role="th">nb_purchaser</th>
<th data-quarto-table-cell-role="th">total_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2017-11</td>
<td>759497</td>
<td>58836</td>
<td>192782711.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2017-12</td>
<td>679573</td>
<td>34938</td>
<td>111758189.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-give-me-a-list-of-unique-users-who-made-at-least-one-purchase-or-viewed-at-least-5-unique-items." class="level3">
<h3 class="anchored" data-anchor-id="example-give-me-a-list-of-unique-users-who-made-at-least-one-purchase-or-viewed-at-least-5-unique-items.">Example: Give me a list of unique users who made at least one purchase or viewed at least 5 unique items.</h3>
<p>Concatenate then deduplicate.</p>
<div id="cf18640c" class="cell" data-execution_count="43">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'buy'</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="ss">union</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'fav'</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="ss">having count(*)&gt;=5</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="43">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>898251</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>576709</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>837520</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">92122</th>
<td>86617</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">92123</th>
<td>906571</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">92124</th>
<td>103138</td>
</tr>
</tbody>
</table>

<p>92125 rows × 1 columns</p>
</div>
</div>
</div>
<p>Simple concatenation will give duplicates.</p>
<div id="515486ae" class="cell" data-execution_count="44">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'buy'</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="ss">union all</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="ss">select </span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="ss">where behavior_type = 'fav'</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="ss">having count(*)&gt;=5</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="44">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>286908</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>910422</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>669209</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">92359</th>
<td>251575</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">92360</th>
<td>598643</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">92361</th>
<td>906629</td>
</tr>
</tbody>
</table>

<p>92362 rows × 1 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="joins" class="level2">
<h2 class="anchored" data-anchor-id="joins">8. Joins</h2>
<p><code>join</code> connects data from one table to another based on columns they share. There are many types of joins but 95% of your life will revolve around <code>left join</code> and <code>inner join</code>.</p>
<section id="example-among-users-who-are-active-have-at-least-one-event-on-2017-12-03-how-many-percent-were-active-in-2017-11" class="level3">
<h3 class="anchored" data-anchor-id="example-among-users-who-are-active-have-at-least-one-event-on-2017-12-03-how-many-percent-were-active-in-2017-11">Example: Among users who are active (have at least one event) on 2017-12-03, how many percent were active in 2017-11</h3>
<p><code>left join</code> starts with all rows from the left-side table (the former one) and add rows from the right-side table (the latter one) to it, <em>if and only if</em> the rows meet the conditions given in the <code>on</code> clause. These conditions are usually for values in a column from the left-side table to be equal to, not equal to, or more/less than the ones in a column from the right-side table.</p>
<p>Be sure to give aliases to columns you select and are joining <code>on</code>. Your query engine needs to know exactly from which table the columns came from if they have the same name.</p>
<div id="35c53f57" class="cell" data-execution_count="45">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="ss">with november_active_tbl as (</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,1 as active_in_november</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="ss">where year_month = '2017-11'</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1,2</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="ss">),</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="ss">dec3_active_tbl as (</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="ss">where event_date = '2017-12-03'</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="ss">)</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="ss"> dec3.user_id</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,active_in_november</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a><span class="ss">from dec3_active_tbl dec3</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a><span class="ss">left join november_active_tbl nov</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="ss">on dec3.user_id = nov.user_id;</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">active_in_november</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>78674</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>755902</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>829454</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">375424</th>
<td>743851</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">375425</th>
<td>543372</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">375426</th>
<td>610566</td>
<td>&lt;NA&gt;</td>
</tr>
</tbody>
</table>

<p>375427 rows × 2 columns</p>
</div>
</div>
</div>
<p>As you can see, users who were not active in 2017-11 will have null values in their <code>active_in_november</code> column. This is because we need to make sure that all rows from the left-side table (<code>dec3_active_tbl</code>) are there. Lastly, we can find the percentage by a simple aggregation. This is how you calculate percentage of returning users.</p>
<div id="cb843f5a" class="cell" data-execution_count="46">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="ss">with november_active_tbl as (</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,1 as active_in_november</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="ss">where year_month = '2017-11'</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1,2</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="ss">),</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="ss">dec3_active_tbl as (</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="ss"> user_id</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="ss">where event_date = '2017-12-03'</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="ss">)</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a><span class="ss"> avg(coalesce(active_in_november,0)) as percent_active_last_month</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="ss">from dec3_active_tbl dec3</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a><span class="ss">left join november_active_tbl nov</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="ss">on dec3.user_id = nov.user_id;</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">percent_active_last_month</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0.824562</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="example-what-is-the-daily-contribution-to-its-total-monthly-sales-expressed-as-percentage" class="level3">
<h3 class="anchored" data-anchor-id="example-what-is-the-daily-contribution-to-its-total-monthly-sales-expressed-as-percentage">Example: What is the daily contribution to its total monthly sales, expressed as percentage?</h3>
<p><code>inner join</code> is used when you only want rows where the <code>on</code> conditions are satisfied for both tables. In this case, we know that <code>year_month</code>, the key we are joining on, exists in both daily and monthly sales tables, so we can use <code>inner join</code> without fear of losing information. <code>inner join</code> has the best performance than <code>left join</code> so prioritize it if you can, especially if you are working with huge tables.</p>
<p>One sneaky thing you can do is that technically you can enter a condition only based on one table in the <code>on</code> clause such as <code>daily_sales &gt; 0</code> below. It will have the same performance as when you do it on <code>where</code> clause.</p>
<div id="f6ca24bf" class="cell" data-execution_count="47">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">10</span>) </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="ss">select setseed(0.112);</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="ss">with monthly_sales_tbl as (</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="ss"> year_month</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,sum(sales) as monthly_sales</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="ss">having sum(sales)&gt;0</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="ss">),</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="ss">daily_sales_tbl as (</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="ss"> year_month</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,event_date</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,sum(sales) as daily_sales</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="ss">from transaction_tbl_x</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="ss">group by 1,2</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="ss">)</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="ss">select</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="ss"> daily.year_month</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,event_date</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a><span class="ss"> ,daily_sales / monthly_sales as percentage_of_monthly_sales</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a><span class="ss">from daily_sales_tbl daily</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a><span class="ss">inner join monthly_sales_tbl monthly</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a><span class="ss">on daily.year_month = monthly.year_month</span></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a><span class="ss"> and daily_sales &gt; 0</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a><span class="ss">order by event_date;</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>execute_query(query)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="47">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">year_month</th>
<th data-quarto-table-cell-role="th">event_date</th>
<th data-quarto-table-cell-role="th">percentage_of_monthly_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2017-11</td>
<td>2017-11-25</td>
<td>0.149288</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2017-11</td>
<td>2017-11-26</td>
<td>0.162279</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2017-11</td>
<td>2017-11-27</td>
<td>0.177516</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2017-11</td>
<td>2017-11-28</td>
<td>0.165055</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2017-11</td>
<td>2017-11-29</td>
<td>0.171182</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2017-11</td>
<td>2017-11-30</td>
<td>0.176354</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2017-12</td>
<td>2017-12-01</td>
<td>0.284772</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2017-12</td>
<td>2017-12-02</td>
<td>0.352953</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2017-12</td>
<td>2017-12-03</td>
<td>0.346453</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2017-12</td>
<td>2017-12-04</td>
<td>0.016650</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="tribal-knowledge" class="level2">
<h2 class="anchored" data-anchor-id="tribal-knowledge">9. Tribal Knowledge</h2>
<p>We have now gone through SQL techniques to accomplish most tasks as a SQL monkey. I would like to close with some tips and tricks I have learned over the years:</p>
<ul>
<li><strong>Get your hands dirty.</strong> Whether it is <a href="https://colab.research.google.com/github/cstorm125/cstorm125.github.io/blob/main/notebook/sql_almost_exercise.ipynb">the exercise</a> or your own data. Get out there and make it happen!</li>
<li><strong>ALWAYS SPECIFY THE PARTITIONS YOU NEED IN THE <code>WHERE</code> CLAUSE</strong>, and use the right data types.</li>
<li><strong>Sanity check</strong> for data quality issues, namely duplicates, missing values, improbable values, and data types. Make sure values in columns you care about are distributed in a reasonable manner.</li>
<li><strong>Work with assumptions and experiments.</strong> Have a set of clear hypotheses about what you are trying to learn/do, compose the query, run it and record the results. Work incrementally and not all at once; lest you will regret it during the debugging process. Do not just randomly write queries and hope for the best. The rabbit hole is too deep.</li>
<li><strong>Performance is king.</strong> Always pick a pattern that results in better performance when possible. For instance, <code>inner join</code> over <code>left join</code>, <code>union all</code> over <code>union</code>, do not use <code>distinct</code> if values are already unique, and so on.</li>
<li><strong>Query code styling must be readable and consistent</strong>. In this day and age where a coding assistant can fix your code styling in a few seconds, the best code styling for your query is the one that is most readable to your team. Whether it is tab vs space identation, leading vs trailing commas, with vs subquery vs view, capitalized vs uncapitalized keywords, just pick one style and stick with it.</li>
<li><strong>When in doubt <code>explain</code></strong>. Most query engines will show you how it plans to execute your queries. If you are a beginner, this might not be extremely helpful, but at least you can catch some simple things like if the partitions you specified are being used, is the engine making some unncessary data type conversion, which part of the process takes the moast time and so on. <code>explain</code> will only show you the plan but <code>explain analyze</code> will execute the query then tell you how it went.</li>
</ul>
<div id="9d1c0b92" class="cell" data-execution_count="48">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="st">explain analyze</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="st">select * from transaction_tbl</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="st">where item_id = 2067266</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="st"> and category_id = 4339722</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(execute_query(query)[<span class="st">'explain_value'</span>][<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>┌─────────────────────────────────────┐
│┌───────────────────────────────────┐│
││    Query Profiling Information    ││
│└───────────────────────────────────┘│
└─────────────────────────────────────┘
 explain analyze select * from transaction_tbl where item_id = 2067266  and category_id = 4339722 
┌────────────────────────────────────────────────┐
│┌──────────────────────────────────────────────┐│
││              Total Time: 0.0016s             ││
│└──────────────────────────────────────────────┘│
└────────────────────────────────────────────────┘
┌───────────────────────────┐
│           QUERY           │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│      EXPLAIN_ANALYZE      │
│    ────────────────────   │
│           0 Rows          │
│          (0.00s)          │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│         PROJECTION        │
│    ────────────────────   │
│          user_id          │
│          item_id          │
│         timestamp         │
│       behavior_type       │
│        category_id        │
│                           │
│           7 Rows          │
│          (0.00s)          │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│         TABLE_SCAN        │
│    ────────────────────   │
│           Table:          │
│      transaction_tbl      │
│                           │
│   Type: Sequential Scan   │
│                           │
│        Projections:       │
│          item_id          │
│        category_id        │
│          user_id          │
│         timestamp         │
│       behavior_type       │
│                           │
│          Filters:         │
│      item_id=2067266      │
│    category_id=4339722    │
│                           │
│           7 Rows          │
│          (0.00s)          │
└───────────────────────────┘
</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/cstorm125\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>